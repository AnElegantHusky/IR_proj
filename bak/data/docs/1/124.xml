<?xml version='1.0' encoding='utf-8'?>
<doc><id>124</id><url>https://docs.python.org/zh-cn/3/library/tracemalloc.html</url><title> --- 跟踪内存分配</title><body>3.4 新版功能.
源代码： Lib/tracemalloc.py
The tracemalloc module is a debug tool to trace memory blocks allocated by
Python. It provides the following information:
Traceback where an object was allocated
Statistics on allocated memory blocks per filename and per line number:
total size, number and average size of allocated memory blocks
Compute the differences between two snapshots to detect memory leaks
To trace most memory blocks allocated by Python, the module should be started
as early as possible by setting the PYTHONTRACEMALLOC environment
variable to 1, or by using -X tracemalloc command line
option. The tracemalloc.start() function can be called at runtime to
start tracing Python memory allocations.
By default, a trace of an allocated memory block only stores the most recent
frame (1 frame). To store 25 frames at startup: set the
PYTHONTRACEMALLOC environment variable to 25, or use the
-X tracemalloc=25 command line option.
显示内存分配最多的10个文件：
Python测试套件的输出示例：
We can see that Python loaded 4855 KiB data (bytecode and constants) from
modules and that the collections module allocated 244 KiB to build
namedtuple types.
See Snapshot.statistics() for more options.
获取两个快照并显示差异：
Example of output before/after running some tests of the Python test suite:
We can see that Python has loaded 8173 KiB of module data (bytecode and
constants), and that this is 4428 KiB more than had been loaded before the
tests, when the previous snapshot was taken. Similarly, the linecache
module has cached 940 KiB of Python source code to format tracebacks, all
of it since the previous snapshot.
If the system has little free memory, snapshots can be written on disk using
the Snapshot.dump() method to analyze the snapshot offline. Then use the
Snapshot.load() method reload the snapshot.
Code to display the traceback of the biggest memory block:
Example of output of the Python test suite (traceback limited to 25 frames):
We can see that the most memory was allocated in the importlib module to
load data (bytecode and constants) from modules: 870.1 KiB. The traceback is
where the importlib loaded data most recently: on the import pdb
line of the doctest module. The traceback may change if a new module is
loaded.
Code to display the 10 lines allocating the most memory with a pretty output,
ignoring &lt;frozen importlib._bootstrap&gt; and &lt;unknown&gt; files:
Python测试套件的输出示例：
See Snapshot.statistics() for more options.
Clear traces of memory blocks allocated by Python.
See also stop().
Get the traceback where the Python object obj was allocated.
Return a Traceback instance, or None if the tracemalloc
module is not tracing memory allocations or did not trace the allocation of
the object.
See also gc.get_referrers() and sys.getsizeof() functions.
Get the maximum number of frames stored in the traceback of a trace.
The tracemalloc module must be tracing memory allocations to
get the limit, otherwise an exception is raised.
The limit is set by the start() function.
Get the current size and peak size of memory blocks traced by the
tracemalloc module as a tuple: (current: int, peak: int).
Get the memory usage in bytes of the tracemalloc module used to store
traces of memory blocks.
Return an int.
True if the tracemalloc module is tracing Python memory
allocations, False otherwise.
See also start() and stop() functions.
Start tracing Python memory allocations: install hooks on Python memory
allocators. Collected tracebacks of traces will be limited to nframe
frames. By default, a trace of a memory block only stores the most recent
frame: the limit is 1. nframe must be greater or equal to 1.
Storing more than 1 frame is only useful to compute statistics grouped
by 'traceback' or to compute cumulative statistics: see the
Snapshot.compare_to() and Snapshot.statistics() methods.
Storing more frames increases the memory and CPU overhead of the
tracemalloc module. Use the get_tracemalloc_memory() function
to measure how much memory is used by the tracemalloc module.
The PYTHONTRACEMALLOC environment variable
(PYTHONTRACEMALLOC=NFRAME) and the -X tracemalloc=NFRAME
command line option can be used to start tracing at startup.
See also stop(), is_tracing() and get_traceback_limit()
functions.
Stop tracing Python memory allocations: uninstall hooks on Python memory
allocators. Also clears all previously collected traces of memory blocks
allocated by Python.
Call take_snapshot() function to take a snapshot of traces before
clearing them.
See also start(), is_tracing() and clear_traces()
functions.
Take a snapshot of traces of memory blocks allocated by Python. Return a new
Snapshot instance.
The snapshot does not include memory blocks allocated before the
tracemalloc module started to trace memory allocations.
Tracebacks of traces are limited to get_traceback_limit() frames. Use
the nframe parameter of the start() function to store more frames.
The tracemalloc module must be tracing memory allocations to take a
snapshot, see the start() function.
See also the get_object_traceback() function.
Filter traces of memory blocks by their address space (domain).
3.6 新版功能.
If inclusive is True (include), match memory blocks allocated
in the address space domain.
If inclusive is False (exclude), match memory blocks not allocated
in the address space domain.
Address space of a memory block (int). Read-only property.
对内存块的跟踪进行筛选。
See the fnmatch.fnmatch() function for the syntax of
filename_pattern. The '.pyc' file extension is
replaced with '.py'.
示例：
Filter(True, subprocess.__file__) only includes traces of the
subprocess module
Filter(False, tracemalloc.__file__) excludes traces of the
tracemalloc module
Filter(False, "&lt;unknown&gt;") excludes empty tracebacks
在 3.5 版更改: The '.pyo' file extension is no longer replaced with '.py'.
在 3.6 版更改: Added the domain attribute.
Address space of a memory block (int or None).
tracemalloc uses the domain 0 to trace memory allocations made by
Python. C extensions can use other domains to trace other resources.
If inclusive is True (include), only match memory blocks allocated
in a file with a name matching filename_pattern at line number
lineno.
If inclusive is False (exclude), ignore memory blocks allocated in
a file with a name matching filename_pattern at line number
lineno.
Line number (int) of the filter. If lineno is None, the filter
matches any line number.
Filename pattern of the filter (str). Read-only property.
If all_frames is True, all frames of the traceback are checked. If
all_frames is False, only the most recent frame is checked.
This attribute has no effect if the traceback limit is 1.  See the
get_traceback_limit() function and Snapshot.traceback_limit
attribute.
Frame of a traceback.
The Traceback class is a sequence of Frame instances.
文件名（字符串）
行号（整形）
Snapshot of traces of memory blocks allocated by Python.
The take_snapshot() function creates a snapshot instance.
Compute the differences with an old snapshot. Get statistics as a sorted
list of StatisticDiff instances grouped by key_type.
See the Snapshot.statistics() method for key_type and cumulative
parameters.
The result is sorted from the biggest to the smallest by: absolute value
of StatisticDiff.size_diff, StatisticDiff.size, absolute
value of StatisticDiff.count_diff, Statistic.count and
then by StatisticDiff.traceback.
将快照写入文件
使用 load() 重载快照。
Create a new Snapshot instance with a filtered traces
sequence, filters is a list of DomainFilter and
Filter instances.  If filters is an empty list, return a new
Snapshot instance with a copy of the traces.
All inclusive filters are applied at once, a trace is ignored if no
inclusive filters match it. A trace is ignored if at least one exclusive
filter matches it.
在 3.6 版更改: DomainFilter instances are now also accepted in filters.
从文件载入快照。
另见 dump().
获取 Statistic 信息列表，按 key_type 分组排序：
key_type
描述
'filename'
文件名
'lineno'
文件名和行号
'traceback'
回溯
If cumulative is True, cumulate size and count of memory blocks of
all frames of the traceback of a trace, not only the most recent frame.
The cumulative mode can only be used with key_type equals to
'filename' and 'lineno'.
The result is sorted from the biggest to the smallest by:
Statistic.size, Statistic.count and then by
Statistic.traceback.
Maximum number of frames stored in the traceback of traces:
result of the get_traceback_limit() when the snapshot was taken.
Traces of all memory blocks allocated by Python: sequence of
Trace instances.
The sequence has an undefined order. Use the Snapshot.statistics()
method to get a sorted list of statistics.
统计内存分配
Snapshot.statistics() 返回 Statistic 实例的列表。.
参见 StatisticDiff 类。
内存块数（整形）。
Total size of memory blocks in bytes (int).
Traceback where the memory block was allocated, Traceback
instance.
Statistic difference on memory allocations between an old and a new
Snapshot instance.
Snapshot.compare_to() returns a list of StatisticDiff
instances. See also the Statistic class.
Number of memory blocks in the new snapshot (int): 0 if
the memory blocks have been released in the new snapshot.
Difference of number of memory blocks between the old and the new
snapshots (int): 0 if the memory blocks have been allocated in
the new snapshot.
Total size of memory blocks in bytes in the new snapshot (int):
0 if the memory blocks have been released in the new snapshot.
Difference of total size of memory blocks in bytes between the old and
the new snapshots (int): 0 if the memory blocks have been
allocated in the new snapshot.
Traceback where the memory blocks were allocated, Traceback
instance.
Trace of a memory block.
The Snapshot.traces attribute is a sequence of Trace
instances.
在 3.6 版更改: Added the domain attribute.
Address space of a memory block (int). Read-only property.
tracemalloc uses the domain 0 to trace memory allocations made by
Python. C extensions can use other domains to trace other resources.
Size of the memory block in bytes (int).
Traceback where the memory block was allocated, Traceback
instance.
Sequence of Frame instances sorted from the oldest frame to the
most recent frame.
A traceback contains at least 1 frame. If the tracemalloc module
failed to get a frame, the filename "&lt;unknown&gt;" at line number 0 is
used.
When a snapshot is taken, tracebacks of traces are limited to
get_traceback_limit() frames. See the take_snapshot() function.
The Trace.traceback attribute is an instance of Traceback
instance.
在 3.7 版更改: Frames are now sorted from the oldest to the most recent, instead of most recent to oldest.
Format the traceback as a list of lines with newlines. Use the
linecache module to retrieve lines from the source code.
If limit is set, format the limit most recent frames if limit
is positive. Otherwise, format the abs(limit) oldest frames.
If most_recent_first is True, the order of the formatted frames
is reversed, returning the most recent frame first instead of last.
Similar to the traceback.format_tb() function, except that
format() does not include newlines.
示例:
输出:
trace --- Trace or track Python statement execution
软件打包和分发
</body></doc>